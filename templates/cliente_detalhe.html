{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">
        <a href="/clientes" style="color: var(--primary); text-decoration: none;"><i class="ph-bold ph-arrow-left"></i></a> 
        Pasta do Cliente
    </h1>

    <div class="card" style="border-top: 4px solid var(--primary); margin-bottom: 20px;">
        <h2 style="margin: 0; color: #fff;">{{ aluno.nome }}</h2>
        <div style="color: var(--text-muted); display: flex; gap: 20px; margin-top: 10px; font-size: 1rem; flex-wrap: wrap;">
            <span><i class="ph-bold ph-graduation-cap"></i> {{ aluno.curso }}</span>
            <span><i class="ph-bold ph-whatsapp-logo"></i> {{ aluno.telefone }}</span>
            {% if aluno.ava_login %}
            <span><i class="ph-bold ph-user-circle"></i> AVA: {{ aluno.ava_login }}</span>
            {% endif %}
            <span style="color: var(--success); font-weight: bold;">R$ {{ "%.2f"|format(aluno.valor or 70.0) }}</span>
        </div>
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <div class="card">
                <h3 style="margin-top: 0; color: var(--warning);"><i class="ph-fill ph-book-bookmark"></i> Temas e Trabalhos Base</h3>
                <form action="/adicionar_tema/{{ aluno.id }}" method="POST" style="margin-bottom: 20px;">
                    <input type="text" name="titulo" placeholder="Título (Ex: Portfólio 1)" style="width: 100%; margin-bottom: 10px;">
                    <textarea name="texto" rows="4" placeholder="Cole o texto do desafio aqui..." required></textarea>
                    <button type="submit" class="btn btn-warning" style="width: 100%; margin-top: 10px;"><i class="ph-bold ph-plus"></i> Salvar Tema</button>
                </form>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    {% for tema in aluno.temas %}
                    <div style="background: rgba(30, 33, 48, 0.5); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                            <h4 style="margin: 0; color: #fff;"><i class="ph-fill ph-text-align-left" style="color: var(--warning);"></i> {{ tema.titulo or 'Tema salvo' }}</h4>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="copiarTema({{ tema.id }})" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem;"><i class="ph-bold ph-copy"></i></button>
                                <button onclick="editarTema({{ tema.id }}, '{{ tema.titulo|default('', true)|replace('\'', '\\\'') }}', `{{ tema.texto|replace('`', '\\`') }}`)" class="btn" style="background:var(--border); padding: 6px 10px; font-size: 0.8rem;"><i class="ph-bold ph-pencil-simple"></i></button>
                                <a href="/deletar_tema/{{ tema.id }}" class="btn btn-danger" style="padding: 6px 10px; font-size: 0.8rem;" onclick="return confirm('Apagar?')"><i class="ph-bold ph-trash"></i></a>
                            </div>
                        </div>
                        <div id="tema-texto-{{ tema.id }}" style="background: rgba(15, 17, 26, 0.6); padding: 15px; border-radius: 6px; font-size: 0.85rem; color: var(--text-muted); max-height: 200px; overflow-y: auto; white-space: pre-wrap;">{{ tema.texto }}</div>
                    </div>
                    {% else %}
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Nenhum tema salvo.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div style="flex: 1; min-width: 300px;">
            <div class="card">
                <h3 style="margin-top: 0; color: var(--success);"><i class="ph-fill ph-file-doc"></i> Documentos e Memoriais</h3>
                <form action="/upload_doc/{{ aluno.id }}" method="POST" enctype="multipart/form-data" style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <input type="file" name="arquivo" accept=".docx,.pdf" required style="flex: 1;">
                    <button type="submit" class="btn btn-green"><i class="ph-bold ph-upload-simple"></i> Enviar Manual</button>
                </form>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    {% for doc in aluno.documentos %}
                    <div style="background: rgba(30, 33, 48, 0.5); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px; overflow: hidden;">
                                <i class="ph-fill ph-file-doc" style="font-size: 1.5rem; color: var(--success);"></i>
                                <span style="color: #e2e8f0; font-weight: 500; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; max-width: 200px;" title="{{ doc.nome_arquivo }}">{{ doc.nome_arquivo }}</span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="renomearDoc({{ doc.id }}, '{{ doc.nome_arquivo|replace('\'', '\\\'') }}')" class="btn" style="background: var(--border); padding: 6px 10px; font-size: 0.8rem;" title="Renomear"><i class="ph-bold ph-pencil-simple"></i></button>
                                
                                <a href="/download_doc/{{ doc.id }}" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem;" title="Baixar Arquivo DOCX"><i class="ph-bold ph-file-word"></i> DOCX</a>
                                
                                {% if doc.dados_pdf %}
                                <a href="/download_pdf/{{ doc.id }}" class="btn btn-danger" style="padding: 6px 10px; font-size: 0.8rem; background: #ef4444;" title="Baixar Arquivo PDF"><i class="ph-bold ph-file-pdf"></i> PDF</a>
                                {% endif %}
                                
                                <a href="/delete_doc/{{ doc.id }}" class="btn btn-danger" style="padding: 6px 10px; font-size: 0.8rem; background: #475569;" onclick="return confirm('Apagar arquivo?')" title="Apagar"><i class="ph-bold ph-trash"></i></a>
                            </div>
                        </div>

                        {% if doc.memorial_analitico %}
                        <div style="margin-top: 10px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 0.85rem; color: var(--warning); font-weight: bold;"><i class="ph-fill ph-text-align-justify"></i> Memorial Analítico (Para o AVA)</span>
                                <button onclick="copiarMemorial({{ doc.id }})" class="btn btn-warning" style="padding: 4px 8px; font-size: 0.75rem;"><i class="ph-bold ph-copy"></i> Copiar Tudo</button>
                            </div>
                            <div id="memorial-{{ doc.id }}" style="background: rgba(15, 17, 26, 0.8); padding: 15px; border-radius: 6px; font-size: 0.85rem; color: var(--text-muted); max-height: 200px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5;">{{ doc.memorial_analitico }}</div>
                        </div>
                        {% endif %}

                    </div>
                    {% else %}
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Nenhum documento anexado.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function copiarTema(id) {
            let texto = document.getElementById('tema-texto-' + id).innerText;
            navigator.clipboard.writeText(texto);
            Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, icon: 'success', title: 'Tema copiado!', background: '#1e2130', color: '#10b981' });
        }

        function copiarMemorial(id) {
            let texto = document.getElementById('memorial-' + id).innerText;
            navigator.clipboard.writeText(texto);
            Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2500, icon: 'success', title: 'Memorial copiado para a Área de Transferência!', background: '#1e2130', color: '#10b981' });
        }

        function editarTema(id, tituloAtual, textoAtual) {
            Swal.fire({
                title: 'Editar Tema/Portfólio',
                html: `
                    <input id="edit-titulo" class="swal2-input" value="${tituloAtual}" placeholder="Título (Ex: Portfólio 2)" style="width: 90%;">
                    <textarea id="edit-texto" class="swal2-textarea" style="width: 90%; height: 200px; font-size: 0.85rem;">${textoAtual}</textarea>
                `,
                background: '#1e2130', color: '#e2e8f0', confirmButtonText: 'Salvar Alterações', confirmButtonColor: '#6366f1', showCancelButton: true, width: '700px',
                preConfirm: () => {
                    let form = document.createElement('form'); form.method = 'POST'; form.action = '/editar_tema/' + id;
                    let iTit = document.createElement('input'); iTit.type = 'hidden'; iTit.name = 'titulo'; iTit.value = document.getElementById('edit-titulo').value;
                    let iTxt = document.createElement('input'); iTxt.type = 'hidden'; iTxt.name = 'texto'; iTxt.value = document.getElementById('edit-texto').value;
                    form.appendChild(iTit); form.appendChild(iTxt); document.body.appendChild(form); form.submit();
                }
            });
        }

        function renomearDoc(id, nomeAtual) {
            Swal.fire({
                title: 'Renomear Arquivo',
                input: 'text',
                inputValue: nomeAtual,
                background: '#1e2130', color: '#e2e8f0', confirmButtonColor: '#10b981', showCancelButton: true,
                preConfirm: (novoNome) => {
                    if (novoNome) {
                        let form = document.createElement('form'); form.method = 'POST'; form.action = '/rename_doc/' + id;
                        let input = document.createElement('input'); input.type = 'hidden'; input.name = 'novo_nome'; input.value = novoNome;
                        form.appendChild(input); document.body.appendChild(form); form.submit();
                    }
                }
            });
        }
    </script>
{% endblock %}
