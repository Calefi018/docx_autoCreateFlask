{% extends "base.html" %}
{% block content %}
    <a href="/clientes" style="color: var(--text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px;">
        <i class="ph-bold ph-arrow-left"></i> Voltar para Clientes
    </a>
    
    <div class="card" style="border-top: 4px solid var(--secondary);">
        <h1 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
            <i class="ph-fill ph-folder-user"></i> Pasta de {{ aluno.nome }}
        </h1>
        <p style="color: var(--text-muted); margin: 0; font-size: 0.95rem;">
            <i class="ph-bold ph-graduation-cap"></i> Curso: {{ aluno.curso }} | 
            <i class="ph-bold ph-whatsapp-logo"></i> Telefone: {{ aluno.telefone }} | 
            <i class="ph-bold ph-currency-dollar"></i> Valor: R$ {{ "%.2f"|format(aluno.valor or 70.0) }}
        </p>
    </div>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="card" style="flex: 1; min-width: 300px;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
                <i class="ph-bold ph-upload-simple"></i> Anexar Trabalho
            </h3>
            <p style="color: var(--text-muted); font-size: 0.85em; margin-bottom: 20px;">
                Você pode enviar arquivos do Word (.docx) ou arquivos em formato PDF (.pdf). Tudo o que anexar aqui ficará disponível no Portal do Aluno.
            </p>
            
            <form action="/upload_doc/{{ aluno.id }}" method="POST" enctype="multipart/form-data">
                <input type="file" name="arquivo" accept=".docx, .pdf" required style="padding: 10px; background: rgba(15,17,26,0.6); border: 1px dashed var(--primary); margin-bottom: 15px;">
                
                <button type="submit" class="btn btn-green" style="width: 100%;">
                    <i class="ph-bold ph-upload"></i> Fazer Upload Seguro
                </button>
            </form>
        </div>

        <div class="card" style="flex: 2; min-width: 300px;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
                <i class="ph-fill ph-files"></i> Arquivos Entregues
            </h3>
            
            <table style="width: 100%; text-align: left; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid var(--border);">
                    <th style="padding: 10px; color: var(--text-muted);">Nome do Arquivo</th>
                    <th style="padding: 10px; color: var(--text-muted);">Ações Rápidas</th>
                </tr>
                
                {% for doc in aluno.documentos %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px 10px; color: #fff; display: flex; align-items: center; gap: 8px;">
                        {% if '.pdf' in doc.nome_arquivo.lower() %}
                            <i class="ph-fill ph-file-pdf" style="color: #ef4444; font-size: 1.5rem;"></i>
                        {% else %}
                            <i class="ph-fill ph-file-doc" style="color: #2196F3; font-size: 1.5rem;"></i>
                        {% endif %}
                        {{ doc.nome_arquivo }}
                    </td>
                    <td style="padding: 15px 10px;">
                        <div style="display: flex; gap: 5px;">
                            <a href="/download_doc/{{ doc.id }}" class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;" title="Baixar Arquivo">
                                <i class="ph-bold ph-download-simple"></i>
                            </a>
                            
                            <button onclick="renomearDoc({{ doc.id }}, '{{ doc.nome_arquivo|replace('\'', '\\\'') }}')" class="btn" style="background: var(--border); padding: 8px 12px; font-size: 0.85rem;" title="Renomear Arquivo">
                                <i class="ph-bold ph-pencil-simple"></i>
                            </button>
                            
                            <a href="/delete_doc/{{ doc.id }}" class="btn btn-danger" style="padding: 8px 12px; font-size: 0.85rem;" onclick="return confirm('Tem certeza que deseja apagar este arquivo? Ele sumirá do Portal do Aluno.')" title="Apagar Arquivo">
                                <i class="ph-bold ph-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="2" style="padding: 20px; text-align: center; color: var(--text-muted);">Nenhum arquivo enviado.</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div class="card" style="margin-top: 20px; border-top: 4px solid var(--warning);">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
            <i class="ph-fill ph-book-bookmark"></i> Banco de Temas do Aluno
        </h3>
        <p style="color: var(--text-muted); font-size: 0.85em; margin-bottom: 20px;">
            Salve os temas, instruções ou portfólios deste cliente. Você pode ter vários temas salvos e copiá-los facilmente quando for gerar um novo trabalho.
        </p>
        
        <form action="/adicionar_tema/{{ aluno.id }}" method="POST" style="margin-bottom: 30px; background: rgba(15,17,26,0.4); padding: 15px; border-radius: 8px; border: 1px dashed var(--border);">
            <input type="text" name="titulo" placeholder="Título Opcional (Ex: Desafio de Pedagogia - Semestre 2)" style="margin-bottom: 10px;">
            <textarea name="texto" rows="4" placeholder="Cole o texto completo do tema ou instruções aqui..." required style="margin-bottom: 10px;"></textarea>
            
            <button type="submit" class="btn btn-warning" style="width: 100%; color: #000;">
                <i class="ph-bold ph-plus"></i> Guardar Tema na Pasta
            </button>
        </form>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            {% for tema in aluno.temas %}
            <div style="background: rgba(30, 33, 48, 0.5); border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <h4 style="margin: 0; color: #fff;">
                        <i class="ph-fill ph-text-align-left" style="color: var(--warning);"></i> 
                        {{ tema.titulo or 'Tema salvo' }}
                        <small style="color: var(--text-muted); font-size: 0.75rem; margin-left: 10px; font-weight: normal;">
                            {{ tema.data_cadastro.strftime('%d/%m/%Y') }}
                        </small>
                    </h4>
                    
                    <div style="display: flex; gap: 5px;">
                        <button onclick="copiarTema({{ tema.id }})" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem;" title="Copiar para usar no Gerador">
                            <i class="ph-bold ph-copy"></i> Copiar Texto
                        </button>
                        
                        <a href="/deletar_tema/{{ tema.id }}" class="btn btn-danger" style="padding: 6px 10px; font-size: 0.8rem;" onclick="event.preventDefault(); confirmarDelecaoTema(this.href)" title="Apagar Tema">
                            <i class="ph-bold ph-trash"></i>
                        </a>
                    </div>
                </div>
                
                <div id="tema-texto-{{ tema.id }}" style="background: rgba(15, 17, 26, 0.6); padding: 15px; border-radius: 6px; font-size: 0.85rem; color: var(--text-muted); max-height: 200px; overflow-y: auto; white-space: pre-wrap; border: 1px solid rgba(255,255,255,0.05);">{{ tema.texto }}</div>
                
            </div>
            {% else %}
                <p style="color: var(--text-muted); text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 8px;">
                    Nenhum tema salvo para este aluno.
                </p>
            {% endfor %}
        </div>
    </div>

    <script>
        function renomearDoc(docId, nomeAtual) {
            Swal.fire({
                title: 'Renomear Arquivo',
                input: 'text',
                inputValue: nomeAtual,
                inputLabel: 'Digite o novo nome (o sistema mantem o .pdf ou .docx sozinho)',
                showCancelButton: true,
                confirmButtonText: 'Renomear',
                background: '#1e2130', 
                color: '#e2e8f0', 
                confirmButtonColor: '#6366f1'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    let form = document.createElement('form'); 
                    form.method = 'POST'; 
                    form.action = '/rename_doc/' + docId;
                    
                    let input = document.createElement('input'); 
                    input.type = 'hidden'; 
                    input.name = 'novo_nome'; 
                    input.value = result.value;
                    
                    form.appendChild(input); 
                    document.body.appendChild(form); 
                    form.submit();
                }
            });
        }

        // Lógica Limpa para Copiar o Texto do Tema
        function copiarTema(id) {
            let texto = document.getElementById('tema-texto-' + id).innerText;
            navigator.clipboard.writeText(texto).then(() => {
                const Toast = Swal.mixin({ 
                    toast: true, 
                    position: 'top-end', 
                    showConfirmButton: false, 
                    timer: 2500, 
                    background: '#1e2130', 
                    color: '#10b981' 
                });
                Toast.fire({ icon: 'success', title: 'Tema copiado! Vá para o Gerador e cole.' });
            });
        }

        // Confirmação segura para apagar Tema
        function confirmarDelecaoTema(url) {
            Swal.fire({
                title: 'Apagar Tema?',
                text: 'Tem certeza que deseja remover este tema do banco de dados?',
                icon: 'warning', 
                background: '#1e2130', 
                color: '#e2e8f0', 
                showCancelButton: true, 
                confirmButtonColor: '#ef4444', 
                cancelButtonColor: '#334155', 
                confirmButtonText: 'Sim, apagar', 
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) { 
                    window.location.href = url; 
                }
            });
        }
    </script>
{% endblock %}
