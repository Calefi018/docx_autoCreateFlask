{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">Revis√£o de Trabalhos Externos</h1>
    <p style="color: #9E9E9E;">O aluno mandou um trabalho ruim? Envie o DOCX aqui. A IA vai ler, criticar e reconstruir no padr√£o oficial da faculdade.</p>

    <div class="card">
        <form id="formRevisao" enctype="multipart/form-data">
            <label><b>1. Tema / Enunciado do Desafio</b></label>
            <textarea name="tema" rows="4" required></textarea>

            <label><b>2. Arquivo do Aluno (.docx)</b></label>
            <input type="file" name="arquivo_trabalho" accept=".docx" required style="padding: 7px;">

            <label><b>3. Modelo IA</b></label>
            <select name="modelo">{% for m in modelos %}<option value="{{ m }}">{{ m }}</option>{% endfor %}</select>

            <button type="submit" class="btn" style="background: #9C27B0; width: 100%; padding: 15px;" id="btn-avaliar">üîç Analisar Trabalho</button>
            <p id="loading-rev" style="display:none; text-align:center; color:#9C27B0; font-weight: bold;">O Professor IA est√° lendo o DOCX...</p>
        </form>
    </div>

    <div id="resultado-avaliacao" class="card" style="display:none; border-color: #9C27B0;">
        <h3 style="color: #E040FB; margin-top: 0;">Parecer do Professor</h3>
        <p id="texto-critica"></p>
        
        <button class="btn" style="background: #9C27B0; width: 100%; padding: 15px;" id="btn-corrigir" onclick="corrigirTrabalho()">‚ú® Aplicar Melhorias e Formatar no Padr√£o</button>
        
        <div id="progress-container-rev" style="display:none; margin-top: 20px;">
            <p id="progress-text-rev" style="text-align:center; color:#E040FB; font-weight: bold; margin-bottom: 5px;">Reescrevendo o documento...</p>
            <div style="width: 100%; background-color: #262730; border-radius: 5px; overflow: hidden; height: 15px; border: 1px solid #444C56;">
                <div id="progress-bar-fill-rev" style="width: 0%; height: 100%; background-color: #E040FB; transition: width 0.5s ease;"></div>
            </div>
            <p style="text-align:center; font-size: 0.8rem; color: #9E9E9E; margin-top: 5px;">A IA est√° reestruturando o texto profundamente com base na cr√≠tica.</p>
        </div>
    </div>

    <script>
        let textoExtraidoGlobal = "";
        let criticaGlobal = "";
        
        document.getElementById('formRevisao').onsubmit = function(e) {
            e.preventDefault();
            document.getElementById('btn-avaliar').style.display = 'none';
            document.getElementById('loading-rev').style.display = 'block';
            
            fetch('/avaliar_avulso', { method: 'POST', body: new FormData(this) })
            .then(async res => {
                const data = await res.json().catch(() => null);
                if (!res.ok) throw new Error(data && data.erro ? data.erro : "Erro de conex√£o com o servidor.");
                return data;
            })
            .then(data => {
                document.getElementById('loading-rev').style.display = 'none';
                if(data.erro) { alert("Erro da IA: " + data.erro); document.getElementById('btn-avaliar').style.display = 'block'; return; }
                
                textoExtraidoGlobal = data.texto_extraido;
                criticaGlobal = data.critica;
                document.getElementById('texto-critica').innerText = criticaGlobal;
                document.getElementById('resultado-avaliacao').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading-rev').style.display = 'none';
                document.getElementById('btn-avaliar').style.display = 'block';
                alert(err.message);
            });
        };

        function corrigirTrabalho() {
            document.getElementById('btn-corrigir').style.display = 'none';
            
            const progressContainer = document.getElementById('progress-container-rev');
            const progressBar = document.getElementById('progress-bar-fill-rev');
            const progressText = document.getElementById('progress-text-rev');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '#E040FB';
            let width = 0;
            
            const progressInterval = setInterval(() => {
                if (width < 95) {
                    width += 1;
                    progressBar.style.width = width + '%';
                    progressText.innerText = `Reescrevendo e formatando... ${width}%`;
                }
            }, 1000);
            
            const fd = new FormData();
            fd.append('tema', document.querySelector('[name="tema"]').value);
            fd.append('texto_extraido', textoExtraidoGlobal);
            fd.append('critica', criticaGlobal);
            fd.append('modelo', document.querySelector('[name="modelo"]').value);

            fetch('/corrigir_avulso', { method: 'POST', body: fd })
            .then(async res => {
                const data = await res.json().catch(() => null);
                if (!res.ok) throw new Error(data && data.erro ? data.erro : "Tempo limite excedido.");
                return data;
            })
            .then(data => {
                clearInterval(progressInterval);
                
                if(data.erro) { 
                    progressBar.style.backgroundColor = '#FF4B4B';
                    progressText.innerText = "Falha!";
                    progressText.style.color = '#FF4B4B';
                    document.getElementById('btn-corrigir').style.display = 'block';
                    alert("Erro ao recriar: " + data.erro); 
                    return; 
                }
                
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#57D2A9';
                progressText.innerText = "Documento Recriado com Sucesso! Baixando...";
                progressText.style.color = '#57D2A9';
                
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,' + data.arquivo_base64;
                link.download = data.nome_arquivo; link.click();
            })
            .catch(err => {
                clearInterval(progressInterval);
                document.getElementById('btn-corrigir').style.display = 'block';
                progressBar.style.backgroundColor = '#FF4B4B';
                progressText.innerText = "Erro na IA";
                progressText.style.color = '#FF4B4B';
                alert(err.message);
            });
        }
    </script>
{% endblock %}
