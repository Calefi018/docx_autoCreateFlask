{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">Gerador de Trabalhos</h1>
    <p style="color: var(--text-muted); margin-bottom: 30px;">Gere o documento, edite se necessário, e vincule a um cliente.</p>

    <form id="formGerar" class="card">
        <label><b>1. Para qual Cliente é este trabalho?</b></label>
        <select name="aluno_id" id="aluno_id">
            <option value="">Não vincular a nenhum cliente (Apenas Baixar)</option>
            {% for aluno in alunos %}
                <option value="{{ aluno.id }}">{{ aluno.nome }} - {{ aluno.curso }}</option>
            {% endfor %}
        </select>

        <label><b>2. Tema do Desafio</b></label>
        <textarea name="tema" rows="6" placeholder="Cole aqui o texto do portal..." required></textarea>

        <div style="display:flex; gap:15px; flex-wrap:wrap;">
            <div style="flex:1; min-width: 250px;">
                <label><b>3. Padrão / Cérebro da IA</b></label>
                <select name="prompt_id">
                    {% for p in prompts %}<option value="{{ p.id }}">{{ p.nome }}</option>{% endfor %}
                </select>
            </div>
            <div style="flex:1; min-width: 250px;">
                <label><b>4. Inteligência Artificial</b></label>
                <select name="modelo" id="select_modelo">
                    {% for modelo in modelos %}<option value="{{ modelo }}">{{ modelo }}</option>{% endfor %}
                </select>
            </div>
        </div>

        <button type="button" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top:10px;" id="btn-submit" onclick="iniciarGeracao()">
            <i class="ph-fill ph-magic-wand"></i> Gerar Rascunho com a IA
        </button>
        
        <div id="loading" style="display:none; text-align:center; margin-top: 20px;">
            <p id="progress-text" style="font-weight: 600; color: var(--primary); margin-bottom: 8px;">A IA está construindo o raciocínio...</p>
            <div style="width: 100%; background-color: var(--bg-color); border-radius: 8px; height: 12px; overflow: hidden; border: 1px solid var(--border);">
                <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: var(--primary); transition: width 0.5s ease;"></div>
            </div>
            <small style="color: var(--text-muted); display: block; margin-top: 8px;">Aguarde. Modelos robustos podem levar até 2 minutos.</small>
        </div>
    </form>

    <div id="area-edicao" class="card" style="display:none; margin-top: 30px; border: 1px solid var(--secondary);">
        <h2 style="color: var(--secondary); margin-top:0; display: flex; align-items: center; gap: 8px;">
            <i class="ph-fill ph-pencil-simple"></i> Pré-visualização e Edição
        </h2>
        <p style="color: var(--text-muted); font-size: 0.95em; margin-bottom: 25px;">Revise os blocos gerados. Modifique o texto como desejar nas caixas abaixo. Quando estiver perfeito, clique no botão verde para gerar o Word.</p>
        
        <div id="caixas-texto"></div>

        <button class="btn btn-green" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top:20px;" onclick="salvarEDocx()" id="btn-docx">
            <i class="ph-fill ph-check-circle"></i> Aprovar e Baixar DOCX Final
        </button>
    </div>

    <script>
        let dicionarioEditavel = {};
        let progressInterval;

        // CORREÇÃO: Removendo as chaves duplas daqui para o Python não apagar a lista
        const ordemOficial = [
            "RESUMO_MEMORIAL", "CONTEXTO_MEMORIAL", "ANALISE_MEMORIAL",
            "ASPECTO_1", "POR_QUE_1", "ASPECTO_2", "POR_QUE_2", "ASPECTO_3", "POR_QUE_3",
            "CONCEITOS_TEORICOS", "ANALISE_CONCEITO_1", "ENTENDIMENTO_TEORICO", "SOLUCOES_TEORICAS",
            "PROPOSTAS_MEMORIAL", "CONCLUSAO_MEMORIAL", "REFERENCIAS_ADICIONAIS", "AUTOAVALIACAO_MEMORIAL"
        ];

        function animarCarregamento() {
            let width = 0;
            const bar = document.getElementById('progress-bar-fill');
            const txt = document.getElementById('progress-text');
            bar.style.width = '0%';
            progressInterval = setInterval(() => {
                if (width < 95) { width += 1; bar.style.width = width + '%'; txt.innerText = `Processando referências... ${width}%`; }
            }, 1000);
        }

        function pararCarregamento() {
            clearInterval(progressInterval);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btn-submit').style.display = 'block';
        }

        function iniciarGeracao(modeloSubstituto = null) {
            const form = document.getElementById('formGerar');
            const formdata = new FormData(form);
            
            if(modeloSubstituto) {
                formdata.set('modelo', modeloSubstituto);
                document.getElementById('select_modelo').value = modeloSubstituto;
            }

            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('area-edicao').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            animarCarregamento();
            
            fetch('/gerar_rascunho', { method: 'POST', body: formdata })
            .then(res => res.json())
            .then(data => {
                pararCarregamento();
                if(!data.sucesso) {
                    if(data.fallback) {
                        Swal.fire({
                            title: 'Servidor Ocupado',
                            html: `A IA selecionada falhou (<strong>${data.failed_model}</strong>).<br><br>Deseja que o sistema tente agora usar a IA substituta:<br><b style="color:var(--primary);">${data.suggested_model}</b>?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#6366f1',
                            cancelButtonColor: '#ef4444',
                            confirmButtonText: 'Sim, tentar substituta!',
                            cancelButtonText: 'Cancelar',
                            background: '#1e2130', color: '#e2e8f0'
                        }).then((result) => {
                            if (result.isConfirmed) { iniciarGeracao(data.suggested_model); }
                        });
                    } else { 
                        Swal.fire({ icon: 'error', title: 'Erro Fatal', text: data.erro, background: '#1e2130', color: '#e2e8f0' });
                    }
                    return;
                }
                dicionarioEditavel = data.dicionario;
                montarEditor(dicionarioEditavel);
                document.getElementById('area-edicao').style.display = 'block';
                window.scrollTo({ top: document.getElementById('area-edicao').offsetTop, behavior: 'smooth' });
            })
            .catch(err => { pararCarregamento(); Swal.fire('Erro', 'Falha na conexão com o servidor.', 'error'); });
        }

        function montarEditor(dic) {
            const container = document.getElementById('caixas-texto');
            container.innerHTML = ''; 
            
            ordemOficial.forEach(chave_base => {
                // CORREÇÃO: Reconstruindo a chave dupla dinamicamente aqui no Javascript
                let chave = "{{" + chave_base + "}}";
                
                if (dic[chave] && dic[chave].trim() !== "") {
                    let tituloAmigavel = chave_base.replace(/_/g, ' ');
                    let wrapper = document.createElement('div');
                    wrapper.style.marginBottom = '15px';
                    
                    let label = document.createElement('label');
                    label.innerHTML = `<b>${tituloAmigavel}</b>`;
                    label.style.color = "var(--secondary)";
                    label.style.display = "block";
                    label.style.marginBottom = "5px";
                    
                    let textarea = document.createElement('textarea');
                    textarea.rows = 5;
                    textarea.value = dic[chave];
                    textarea.dataset.chave = chave;
                    textarea.onchange = (e) => { dicionarioEditavel[e.target.dataset.chave] = e.target.value; };
                    
                    wrapper.appendChild(label);
                    wrapper.appendChild(textarea);
                    container.appendChild(wrapper);
                }
            });
        }

        function salvarEDocx() {
            document.getElementById('btn-docx').innerHTML = "<i class='ph ph-spinner animate-spin'></i> Gerando documento...";
            document.getElementById('btn-docx').disabled = true;

            const textareas = document.querySelectorAll('#caixas-texto textarea');
            textareas.forEach(ta => { dicionarioEditavel[ta.dataset.chave] = ta.value; });
            const alunoId = document.getElementById('aluno_id').value;

            fetch('/gerar_docx_final', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dicionario: dicionarioEditavel, aluno_id: alunoId })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('btn-docx').innerHTML = "<i class='ph-fill ph-check-circle'></i> Aprovar e Baixar DOCX Final";
                document.getElementById('btn-docx').disabled = false;
                if(!data.sucesso) { Swal.fire('Erro', data.erro, 'error'); return; }
                
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,' + data.arquivo_base64;
                link.download = "Trabalho_Finalizado.docx"; 
                link.click();
                
                document.getElementById('area-edicao').style.display = 'none';
                Swal.fire({
                    icon: 'success',
                    title: 'Documento Gerado!',
                    text: 'O Word foi baixado e salvo na pasta do cliente.',
                    background: '#1e2130', color: '#e2e8f0', confirmButtonColor: '#10b981'
                });
            })
            .catch(err => {
                document.getElementById('btn-docx').innerHTML = "<i class='ph-fill ph-check-circle'></i> Aprovar e Baixar DOCX Final";
                document.getElementById('btn-docx').disabled = false;
                Swal.fire('Erro', 'Falha ao gerar o arquivo.', 'error');
            });
        }
    </script>
{% endblock %}
