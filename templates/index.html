import os
import io
import json
from flask import Flask, render_template, request, send_file, jsonify
from docx import Document
import google.generativeai as genai

app = Flask(__name__)

CHAVE_API = os.environ.get("GEMINI_API_KEY")
if CHAVE_API:
    genai.configure(api_key=CHAVE_API)

# =========================================================
# FUNÇÕES DA FERRAMENTA 1: PREENCHEDOR CLÁSSICO (COM TAGS)
# =========================================================
def preencher_template_com_tags(arquivo_template, dicionario_dados):
    doc = Document(arquivo_template)

    def processar_paragrafo(paragrafo):
        texto_original = paragrafo.text
        tem_tag = False
        
        for marcador, texto_novo in dicionario_dados.items():
            if marcador in texto_original:
                texto_original = texto_original.replace(marcador, str(texto_novo))
                tem_tag = True
                
        if tem_tag:
            paragrafo.clear()
            linhas = texto_original.split('\n')
            for i, linha in enumerate(linhas):
                partes = linha.split('**')
                for j, parte in enumerate(partes):
                    if parte: 
                        run = paragrafo.add_run(parte)
                        if j % 2 == 1: 
                            run.bold = True
                if i < len(linhas) - 1:
                    paragrafo.add_run('\n')

    for paragrafo in doc.paragraphs:
        processar_paragrafo(paragrafo)

    for tabela in doc.tables:
        for linha in tabela.rows:
            for celula in linha.cells:
                for paragrafo in celula.paragraphs:
                    processar_paragrafo(paragrafo)

    arquivo_saida = io.BytesIO()
    doc.save(arquivo_saida)
    arquivo_saida.seek(0)
    return arquivo_saida

def gerar_respostas_ia_tags(texto_tema, nome_modelo):
    modelo = genai.GenerativeModel(nome_modelo)
    prompt = f"""
    Atue como um Especialista Acadêmico Sênior resolvendo um Desafio Profissional de nível universitário.
    
    REGRA MÁXIMA DE QUALIDADE: 
    O conteúdo deve ser DENSO, ANALÍTICO e PROFUNDO. Evite respostas rasas. 
    Use vocabulário técnico da disciplina e explique os conceitos de forma robusta e interligada ao caso.
    
    REGRAS DE FORMATAÇÃO:
    - Vá DIRETO ao conteúdo. NÃO use saudações ou encerramentos.
    - Para destacar palavras e títulos, use **negrito**. 
    - NUNCA use asteriscos simples (*) para listas, use apenas o traço (-).
    - Para pular linha, use a quebra de linha normal (\\n).
    
    TEMA/CASO DO DESAFIO:
    {texto_tema}
    
    Você DEVE retornar as seguintes chaves no JSON, preenchendo com textos ricos e extensos:
    {{
        "ASPECTO_1": "Descreva o aspecto 1 de forma detalhada e acadêmica.",
        "POR_QUE_1": "Justifique com base na teoria e no contexto do caso de forma profunda (mínimo 3 a 4 linhas).",
        "ASPECTO_2": "Descreva o aspecto 2 de forma detalhada.",
        "POR_QUE_2": "Justifique profundamente a escolha do aspecto 2.",
        "ASPECTO_3": "Descreva o aspecto 3 de forma detalhada.",
        "POR_QUE_3": "Justifique profundamente a escolha do aspecto 3.",
        "CONCEITOS_TEORICOS": "- **[Nome do Conceito 1]:** [Definição completa e extensa de como ajuda a entender o caso]\\n- **[Nome do Conceito 2]:** [Definição completa...]",
        "RESP_AUTORRESP": "Análise teórica profunda e aplicada ao cenário específico do desafio...",
        "RESP_PILARES": "Análise teórica densa sobre o problema central...",
        "RESP_SOLUCOES": "Apresente um plano de ação robusto, listando as soluções e justificando-as teoricamente...",
        "RESUMO_MEMORIAL": "Resumo executivo do caso, bem articulado e estruturado...",
        "CONTEXTO_MEMORIAL": "Contextualização rica: Quem? Onde? Qual a complexidade da situação?...",
        "ANALISE_MEMORIAL": "Análise aprofundada utilizando 2 a 3 conceitos da disciplina conectados aos fatos do caso...",
        "PROPOSTAS_MEMORIAL": "Recomendações detalhadas em parágrafos estruturados (não seja breve)...",
        "CONCLUSAO_MEMORIAL": "Conclusão reflexiva madura sobre o aprendizado do caso...",
        "AUTOAVALIACAO_MEMORIAL": "Autoavaliação crítica sobre o desenvolvimento acadêmico do aluno na resolução."
    }}
    """
    try:
        resposta = modelo.generate_content(
            prompt,
            generation_config={"response_mime_type": "application/json"}
        )
        dicionario_dados = json.loads(resposta.text)
        
        dicionario_higienizado = {}
        for chave, texto_gerado in dicionario_dados.items():
            chave_limpa = chave.replace("{", "").replace("}", "").strip()
            chave_marcador = f"{{{{{chave_limpa}}}}}"
            dicionario_higienizado[chave_marcador] = str(texto_gerado).strip()
            
        return dicionario_higienizado
    except Exception as e:
        raise Exception(f"Falha na IA (Tags): {str(e)}")

# =========================================================
# FUNÇÕES DA FERRAMENTA 2: GERADOR UNIVERSAL (GABARITO)
# =========================================================
def extrair_texto_docx(arquivo_upload):
    doc = Document(arquivo_upload)
    texto_completo = [p.text for p in doc.paragraphs if p.text.strip()]
    return "\n".join(texto_completo)

def gerar_resolucao_inteligente_gabarito(texto_template, texto_tema, nome_modelo):
    modelo = genai.GenerativeModel(nome_modelo)
    prompt = f"""
    Atue como um Especialista Acadêmico Sênior resolvendo um Desafio Profissional.
    TEMA/CASO: {texto_tema}
    TEMPLATE: {texto_template}
    
    REGRA MÁXIMA DE COMPORTAMENTO:
    - É EXPRESSAMENTE PROIBIDO iniciar o texto com saudações (ex: "Olá", "Bem-vindo", "Aqui está").
    - É EXPRESSAMENTE PROIBIDO terminar com mensagens conversacionais (ex: "Espero ter ajudado", "Bons estudos").
    - O conteúdo deve ser DENSO, RICO, COM PARÁGRAFOS EXTENSOS E VOCABULÁRIO TÉCNICO. Não seja raso!
    
    A SAÍDA DEVE SEGUIR RIGOROSAMENTE ESTA ESTRUTURA VISUAL E DE CONTEÚDO:
    
    **1. Apresentação do Desafio Profissional**
    [Escreva uma análise densa e detalhada sobre o contexto inicial do desafio]
    
    **2. Materiais de Referência (Ambientação)**
    - **Aspecto 1:** [Escreva de forma aprofundada o aspecto e o porquê]
    - **Aspecto 2:** [Escreva de forma aprofundada o aspecto e o porquê]
    - **Aspecto 3:** [Escreva de forma aprofundada o aspecto e o porquê]
    
    **3. Levantamento de Conceitos Teóricos**
    - **[Nome do Conceito 1]:** [Definição extensa e como se aplica]
    - **[Nome do Conceito 2]:** [Definição extensa e como se aplica]
    - **[Nome do Conceito 3]:** [Definição extensa e como se aplica]
    - **[Nome do Conceito 4]:** [Definição extensa e como se aplica]
    
    **4. Aplicação dos Conceitos Teóricos ao Desafio Profissional**
    - **Como o conceito X explica o que aconteceu na situação?**
      [Resposta analítica, longa e rica em detalhes conectando teoria e prática]
    - **O que a teoria nos ajuda a entender sobre o problema central?**
      [Resposta aprofundada detalhando as nuances do problema]
    - **Que soluções possíveis a teoria aponta (e por que elas fazem sentido)?**
      [Plano de ação robusto e bem justificado]
      
    **5. AVALIATIVA: Redação do Produto - Memorial Analítico**
    **Resumo do que você descobriu:** [Parágrafo denso]
    **Contextualização do desafio:** [Parágrafo denso com Quem, Onde e Qual a Situação]
    **Análise:** [Parágrafo profundo utilizando os conceitos para explicar a situação]
    **Propostas de solução:** [Lista detalhada ou parágrafos extensos de soluções plausíveis]
    **Conclusão reflexiva:** [Aprendizado rico do aluno]
    **Referências:** [Referências acadêmicas reais]
    **Autoavaliação:** [Análise crítica sobre o processo de estudo do aluno]
    """
    try:
        resposta = modelo.generate_content(prompt)
        if not resposta.parts:
            raise Exception("A resposta foi bloqueada pelos filtros de segurança do Google.")
        return resposta.text
    except Exception as e:
        raise Exception(f"Falha na IA (Gabarito): {str(e)}")

# =========================================================
# ROTAS WEB
# =========================================================
@app.route('/')
def index():
    modelos_disponiveis = []
    if CHAVE_API:
        try:
            for m in genai.list_models():
                if 'generateContent' in m.supported_generation_methods:
                    modelos_disponiveis.append(m.name.replace('models/', ''))
        except:
            pass
            
    # Força a inclusão do 1.5 Flash (com 1500 requisições diárias)
    if "gemini-1.5-flash" not in modelos_disponiveis:
        modelos_disponiveis.insert(0, "gemini-1.5-flash")
        
    if not modelos_disponiveis:
        modelos_disponiveis = ["gemini-1.5-flash", "gemini-2.5-flash"]
        
    return render_template('index.html', modelos=modelos_disponiveis)

@app.route('/processar', methods=['POST'])
def processar():
    try:
        if not CHAVE_API:
            genai.configure(api_key=os.environ.get("GEMINI_API_KEY"))
            
        ferramenta = request.form.get('ferramenta')
        modelo_escolhido = request.form.get('modelo')
        texto_tema = request.form.get('tema')
        arquivo_upload = request.files['arquivo']
        
        if not arquivo_upload or not texto_tema:
            return jsonify({"erro": "Arquivo Word ou tema do desafio não foram enviados."}), 400

        arquivo_memoria = io.BytesIO(arquivo_upload.read())

        if ferramenta == 'preenchedor':
            respostas_geradas = gerar_respostas_ia_tags(texto_tema, modelo_escolhido)
            if respostas_geradas:
                documento_pronto = preencher_template_com_tags(arquivo_memoria, respostas_geradas)
                return send_file(
                    documento_pronto, 
                    as_attachment=True, 
                    download_name="Desafio_Preenchido_Perfeito.docx",
                    mimetype="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                )
        
        elif ferramenta == 'gabarito':
            texto_do_template = extrair_texto_docx(arquivo_memoria)
            resposta_ia = gerar_resolucao_inteligente_gabarito(texto_do_template, texto_tema, modelo_escolhido)
            if resposta_ia:
                return jsonify({"tipo": "texto", "conteudo": resposta_ia})
                
        return jsonify({"erro": "Opção inválida selecionada."}), 400
        
    except Exception as e:
        return jsonify({"erro": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
