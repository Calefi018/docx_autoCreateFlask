{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">Gerador de Trabalhos</h1>
    <p style="color: #9E9E9E; margin-bottom: 30px;">Gere o documento e vincule automaticamente a um cliente.</p>

    <form id="formGerar">
        <label><b>1. Para qual Cliente Ã© este trabalho?</b></label>
        <select name="aluno_id">
            <option value="">NÃ£o vincular a nenhum cliente (Apenas Baixar)</option>
            {% for aluno in alunos %}
                <option value="{{ aluno.id }}">{{ aluno.nome }} - {{ aluno.curso }}</option>
            {% endfor %}
        </select>

        <label><b>2. Tema do Desafio</b></label>
        <textarea name="tema" rows="6" placeholder="Cole aqui o texto do portal..." required></textarea>

        <label><b>3. InteligÃªncia Artificial</b></label>
        <select name="modelo">
            {% for modelo in modelos %}<option value="{{ modelo }}">{{ modelo }}</option>{% endfor %}
        </select>

        <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem;" id="btn-submit">ðŸš€ Gerar e Salvar Documento</button>
        
        <div id="progress-container" style="display:none; margin-top: 20px;">
            <p id="progress-text" style="text-align:center; color:#2196F3; font-weight: bold; margin-bottom: 5px;">Iniciando IA...</p>
            <div style="width: 100%; background-color: #262730; border-radius: 5px; overflow: hidden; height: 15px; border: 1px solid #444C56;">
                <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: #2196F3; transition: width 0.5s ease;"></div>
            </div>
            <p style="text-align:center; font-size: 0.8rem; color: #9E9E9E; margin-top: 5px;">IAs de 70 BilhÃµes de parÃ¢metros podem levar atÃ© 2 minutos para estruturar o raciocÃ­nio profundo.</p>
        </div>
    </form>

    <div id="resultado" class="card" style="display:none; margin-top: 30px; border-left: 5px solid #57D2A9;">
        <h3 style="color: #57D2A9; margin-top: 0;">âœ… Trabalho Gerado com Sucesso!</h3>
        <p>Se vocÃª selecionou um cliente, o DOCX jÃ¡ foi salvo permanentemente na pasta dele.</p>
        <button class="btn btn-blue" onclick="baixarDoc()">ðŸ“¥ Baixar DOCX Novamente</button>
    </div>

    <script>
        let base64Doc = "";
        
        function baixarDoc() {
            const link = document.createElement('a');
            link.href = 'data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,' + base64Doc;
            link.download = "Desafio_Gerado.docx"; 
            link.click();
        }

        document.getElementById('formGerar').onsubmit = function(e) {
            e.preventDefault();
            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('resultado').style.display = 'none';
            
            // Controle da Barra de Progresso
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '#2196F3';
            let width = 0;
            
            // Simula o carregamento lentamente atÃ© 95%
            const progressInterval = setInterval(() => {
                if (width < 95) {
                    width += 1;
                    progressBar.style.width = width + '%';
                    progressText.innerText = `Lendo referÃªncias e redigindo... ${width}%`;
                }
            }, 1000); // Sobe 1% a cada 1 segundo (ideal para os modelos TitÃ£s)
            
            fetch('/processar', { method: 'POST', body: new FormData(this) })
            .then(async res => {
                const data = await res.json().catch(() => null);
                if (!res.ok) {
                    if (data && data.erro) throw new Error(data.erro);
                    throw new Error("O servidor da IA demorou demais ou estÃ¡ fora do ar no momento.");
                }
                return data;
            })
            .then(data => {
                clearInterval(progressInterval);
                document.getElementById('btn-submit').style.display = 'block';
                
                if(data.erro) { 
                    progressBar.style.backgroundColor = '#FF4B4B';
                    progressText.innerText = "Falha na GeraÃ§Ã£o!";
                    progressText.style.color = '#FF4B4B';
                    alert("Erro na IA: " + data.erro); 
                    return; 
                }
                
                // Sucesso Total
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#57D2A9';
                progressText.innerText = "ConcluÃ­do com Sucesso! 100%";
                progressText.style.color = '#57D2A9';
                
                base64Doc = data.arquivo_base64;
                document.getElementById('resultado').style.display = 'block';
                baixarDoc();
            })
            .catch(err => {
                clearInterval(progressInterval);
                document.getElementById('btn-submit').style.display = 'block';
                progressBar.style.backgroundColor = '#FF4B4B';
                progressText.innerText = "Erro!";
                progressText.style.color = '#FF4B4B';
                alert("Aviso: " + err.message);
            });
        };
    </script>
{% endblock %}
