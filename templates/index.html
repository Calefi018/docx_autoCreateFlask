{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">Gerador de Trabalhos</h1>
    <p style="color: #9E9E9E; margin-bottom: 30px;">Gere o documento, edite se necess√°rio, e vincule a um cliente.</p>

    <form id="formGerar">
        <label><b>1. Para qual Cliente √© este trabalho?</b></label>
        <select name="aluno_id" id="aluno_id">
            <option value="">N√£o vincular a nenhum cliente (Apenas Baixar)</option>
            {% for aluno in alunos %}
                <option value="{{ aluno.id }}">{{ aluno.nome }} - {{ aluno.curso }}</option>
            {% endfor %}
        </select>

        <label><b>2. Tema do Desafio</b></label>
        <textarea name="tema" rows="6" placeholder="Cole aqui o texto do portal..." required></textarea>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width: 250px;">
                <label><b>3. Padr√£o / C√©rebro da IA</b></label>
                <select name="prompt_id">
                    {% for p in prompts %}
                        <option value="{{ p.id }}">{{ p.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="flex:1; min-width: 250px;">
                <label><b>4. Intelig√™ncia Artificial</b></label>
                <select name="modelo" id="select_modelo">
                    {% for modelo in modelos %}<option value="{{ modelo }}">{{ modelo }}</option>{% endfor %}
                </select>
            </div>
        </div>

        <button type="button" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top:20px;" id="btn-submit" onclick="iniciarGeracao()">üöÄ 1¬∫ Passo: Gerar Rascunho com a IA</button>
        
        <div id="loading" style="display:none; text-align:center; color:#2196F3; margin-top: 20px;">
            <p id="progress-text" style="font-weight: bold; margin-bottom: 5px;">A IA est√° construindo o racioc√≠nio...</p>
            <div style="width: 100%; background-color: #262730; border-radius: 5px; height: 15px;">
                <div id="progress-bar-fill" style="width: 0%; height: 100%; background-color: #2196F3; transition: width 0.5s ease;"></div>
            </div>
            <small style="color: #9E9E9E;">Aguarde. Modelos robustos podem levar at√© 2 minutos.</small>
        </div>
    </form>

    <div id="area-edicao" class="card" style="display:none; margin-top: 30px; border-color: #E040FB;">
        <h3 style="color: #E040FB; margin-top:0;">‚úèÔ∏è Pr√©-visualiza√ß√£o e Edi√ß√£o Manual</h3>
        <p style="color: #9E9E9E; font-size: 0.9em;">Revise os blocos gerados pela IA. Se algo estiver estranho, voc√™ pode digitar e consertar agora mesmo. Quando estiver perfeito, clique no bot√£o verde abaixo para montar o DOCX.</p>
        
        <div id="caixas-texto"></div> <button class="btn btn-green" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top:20px;" onclick="salvarEDocx()" id="btn-docx">‚úÖ 2¬∫ Passo: Aprovar Rascunho e Baixar DOCX Final</button>
    </div>

    <script>
        let dicionarioEditavel = {};
        let progressInterval;

        function animarCarregamento() {
            let width = 0;
            const bar = document.getElementById('progress-bar-fill');
            const txt = document.getElementById('progress-text');
            bar.style.width = '0%';
            bar.style.backgroundColor = '#2196F3';
            progressInterval = setInterval(() => {
                if (width < 95) { width += 1; bar.style.width = width + '%'; txt.innerText = `Processando refer√™ncias... ${width}%`; }
            }, 1000);
        }

        function pararCarregamento() {
            clearInterval(progressInterval);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btn-submit').style.display = 'block';
        }

        function iniciarGeracao(modeloSubstituto = null) {
            const form = document.getElementById('formGerar');
            const formdata = new FormData(form);
            
            if(modeloSubstituto) {
                formdata.set('modelo', modeloSubstituto);
                document.getElementById('select_modelo').value = modeloSubstituto;
            }

            document.getElementById('btn-submit').style.display = 'none';
            document.getElementById('area-edicao').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            animarCarregamento();
            
            fetch('/gerar_rascunho', { method: 'POST', body: formdata })
            .then(res => res.json())
            .then(data => {
                pararCarregamento();

                if(!data.sucesso) {
                    if(data.fallback) {
                        // SISTEMA DE FALLBACK AUTOM√ÅTICO
                        let msg = `‚ö†Ô∏è A IA selecionada (${data.failed_model}) falhou ou os servidores est√£o superlotados.\n\nMotivo: ${data.erro}\n\nDeseja que o sistema tente novamente agora usando a IA substituta: ${data.suggested_model}?`;
                        if(confirm(msg)) {
                            iniciarGeracao(data.suggested_model);
                        }
                    } else {
                        alert("Erro fatal: " + data.erro);
                    }
                    return;
                }

                // Exibe as caixas de edi√ß√£o
                dicionarioEditavel = data.dicionario;
                montarEditor(dicionarioEditavel);
                document.getElementById('area-edicao').style.display = 'block';
                window.scrollTo({ top: document.getElementById('area-edicao').offsetTop, behavior: 'smooth' });
            })
            .catch(err => {
                pararCarregamento();
                alert("Erro de conex√£o com o servidor. Tente novamente.");
            });
        }

        function montarEditor(dic) {
            const container = document.getElementById('caixas-texto');
            container.innerHTML = ''; 
            
            for (const [chave, texto] of Object.entries(dic)) {
                if (texto.trim() === "") continue; 
                
                let tituloAmigavel = chave.replace('{{', '').replace('}}', '').replace(/_/g, ' ');
                let wrapper = document.createElement('div');
                wrapper.style.marginBottom = '15px';
                
                let label = document.createElement('label');
                label.innerHTML = `<b>${tituloAmigavel}</b>`;
                label.style.color = "#2196F3";
                label.style.display = "block";
                label.style.marginBottom = "5px";
                
                let textarea = document.createElement('textarea');
                textarea.rows = 5;
                textarea.value = texto;
                textarea.dataset.chave = chave;
                textarea.onchange = (e) => { dicionarioEditavel[e.target.dataset.chave] = e.target.value; };
                
                wrapper.appendChild(label);
                wrapper.appendChild(textarea);
                container.appendChild(wrapper);
            }
        }

        function salvarEDocx() {
            document.getElementById('btn-docx').innerText = "Aguarde, gerando documento...";
            document.getElementById('btn-docx').disabled = true;

            const textareas = document.querySelectorAll('#caixas-texto textarea');
            textareas.forEach(ta => { dicionarioEditavel[ta.dataset.chave] = ta.value; });

            const alunoId = document.getElementById('aluno_id').value;

            fetch('/gerar_docx_final', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dicionario: dicionarioEditavel, aluno_id: alunoId })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('btn-docx').innerText = "‚úÖ 2¬∫ Passo: Aprovar Rascunho e Baixar DOCX Final";
                document.getElementById('btn-docx').disabled = false;

                if(!data.sucesso) { alert("Erro ao gerar Word: " + data.erro); return; }
                
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,' + data.arquivo_base64;
                link.download = "Desafio_Finalizado.docx"; 
                link.click();
                
                document.getElementById('area-edicao').style.display = 'none';
                alert("‚úÖ Word gerado perfeitamente! Se voc√™ selecionou um cliente, o documento j√° foi salvo na pasta dele.");
            })
            .catch(err => {
                document.getElementById('btn-docx').innerText = "‚úÖ 2¬∫ Passo: Aprovar Rascunho e Baixar DOCX Final";
                document.getElementById('btn-docx').disabled = false;
                alert("Erro ao conectar com o gerador de DOCX.");
            });
        }
    </script>
{% endblock %}