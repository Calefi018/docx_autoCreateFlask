{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">Meus Clientes</h1>
    
    <div class="card" style="border-top: 4px solid var(--primary);">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-user-plus"></i> Cadastrar Novo</h3>
        <form method="POST" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" name="nome" placeholder="Nome do Aluno" required style="flex: 2; min-width: 150px;">
            <input type="text" name="curso" placeholder="Curso/Disciplina" style="flex: 2; min-width: 150px;">
            <input type="text" name="telefone" placeholder="WhatsApp" style="flex: 2; min-width: 150px;">
            <input type="number" name="valor" placeholder="Valor (R$)" value="70.0" step="0.01" required style="flex: 1; min-width: 100px;">
            <button type="submit" class="btn btn-green" style="height: 44px; margin-top: 8px;"><i class="ph-bold ph-plus"></i> Cadastrar</button>
        </form>
    </div>

    <h3 style="color: var(--danger); display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-hourglass-high"></i> Trabalhos a Receber</h3>
    {% for aluno in alunos_pendentes %}
        <div class="card" style="border-left: 4px solid var(--danger); padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0; color: #fff;">{{ aluno.nome }}</h3>
                    <div style="color: var(--text-muted); display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-top: 8px; font-size: 0.9rem;">
                        <span><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</span>
                        <span><i class="ph ph-whatsapp-logo"></i> {{ aluno.telefone }}</span>
                        <span style="display: flex; align-items: center; background: rgba(99, 102, 241, 0.1); padding: 4px 10px; border-radius: 6px; color: var(--primary); font-weight: bold;">
                            R$ {{ "%.2f"|format(aluno.valor or 70.0) }}
                            <button type="button" onclick="editarValor({{ aluno.id }}, {{ aluno.valor or 70.0 }})" style="background: none; border: none; cursor: pointer; color: var(--text-muted); margin-left: 8px;" title="Edição Rápida de Valor"><i class="ph-fill ph-pencil-simple"></i></button>
                        </span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <form action="/toggle_status/{{ aluno.id }}" method="POST" style="margin:0;">
                        <button type="submit" class="btn btn-green" title="Marcar como Pago"><i class="ph-bold ph-currency-dollar"></i> Recebido</button>
                    </form>
                    <a href="/cliente/{{ aluno.id }}" class="btn btn-blue" title="Abrir Arquivos"><i class="ph-bold ph-folder-open"></i> Pasta</a>
                    
                    <button type="button" onclick="editarClienteTotal({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', {{ aluno.valor or 70.0 }})" class="btn" style="background: var(--border); padding: 10px 14px;" title="Editar Dados do Cliente"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button type="button" onclick="deletarCliente({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}')" class="btn btn-danger" style="padding: 10px 14px;" title="Apagar Cliente"><i class="ph-bold ph-trash"></i></button>
                </div>
            </div>
        </div>
    {% else %}
        <p style="color: var(--text-muted);"><i class="ph ph-info"></i> Nenhum trabalho pendente.</p>
    {% endfor %}

    <hr style="border: 0; border-top: 1px solid var(--border); margin: 40px 0;">

    <h3 style="color: var(--success); display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-check-circle"></i> Clientes Pagos</h3>
    {% for aluno in alunos_pagos %}
        <div class="card" style="border-left: 4px solid var(--success); opacity: 0.7; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0; color: #fff;">{{ aluno.nome }}</h3>
                    <div style="color: var(--text-muted); display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-top: 8px; font-size: 0.9rem;">
                        <span><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</span>
                        <span><i class="ph ph-whatsapp-logo"></i> {{ aluno.telefone }}</span>
                        <span style="display: flex; align-items: center;">
                            <b>R$ {{ "%.2f"|format(aluno.valor or 70.0) }}</b>
                            <button type="button" onclick="editarValor({{ aluno.id }}, {{ aluno.valor or 70.0 }})" style="background: none; border: none; cursor: pointer; color: var(--text-muted); margin-left: 8px;" title="Edição Rápida de Valor"><i class="ph-fill ph-pencil-simple"></i></button>
                        </span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <form action="/toggle_status/{{ aluno.id }}" method="POST" style="margin:0;">
                        <button type="submit" class="btn" style="background: var(--border);" title="Retornar para Pendentes"><i class="ph-bold ph-arrow-u-up-left"></i> Estornar</button>
                    </form>
                    <a href="/cliente/{{ aluno.id }}" class="btn btn-blue" title="Abrir Arquivos"><i class="ph-bold ph-folder-open"></i> Pasta</a>
                    
                    <button type="button" onclick="editarClienteTotal({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', {{ aluno.valor or 70.0 }})" class="btn" style="background: var(--border); padding: 10px 14px;" title="Editar Dados do Cliente"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button type="button" onclick="deletarCliente({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}')" class="btn btn-danger" style="padding: 10px 14px;" title="Apagar Cliente"><i class="ph-bold ph-trash"></i></button>
                </div>
            </div>
        </div>
    {% else %}
        <p style="color: var(--text-muted);"><i class="ph ph-info"></i> Nenhum cliente recebido ainda.</p>
    {% endfor %}

    <script>
        // Mantém a edição rápida do valor apenas
        function editarValor(idAluno, valorAtual) {
            Swal.fire({
                title: 'Ajuste Rápido de Valor',
                input: 'text',
                inputValue: valorAtual,
                inputLabel: 'Introduza o novo valor em Reais',
                showCancelButton: true,
                confirmButtonText: 'Salvar Valor',
                cancelButtonText: 'Cancelar',
                background: '#1e2130', color: '#e2e8f0', confirmButtonColor: '#6366f1',
                inputValidator: (value) => { if (!value || isNaN(value.replace(',', '.'))) return 'Insira um número válido!' }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    let form = document.createElement('form');
                    form.method = 'POST'; form.action = '/editar_valor/' + idAluno;
                    let input = document.createElement('input');
                    input.type = 'hidden'; input.name = 'novo_valor'; input.value = result.value;
                    form.appendChild(input); document.body.appendChild(form); form.submit();
                }
            });
        }

        // NOVO: Edição Completa de todos os Dados do Cliente
        function editarClienteTotal(id, nome, curso, telefone, valor) {
            Swal.fire({
                title: 'Editar Ficha do Cliente',
                html: `
                    <div style="text-align: left; margin-top: 15px;">
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Nome do Aluno</label>
                        <input id="swal-nome" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15, 17, 26, 0.6); color: #fff; border: 1px solid var(--border);" value="${nome}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Curso/Disciplina</label>
                        <input id="swal-curso" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15, 17, 26, 0.6); color: #fff; border: 1px solid var(--border);" value="${curso}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">WhatsApp</label>
                        <input id="swal-tel" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15, 17, 26, 0.6); color: #fff; border: 1px solid var(--border);" value="${telefone}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Valor Acordado (R$)</label>
                        <input id="swal-valor" type="number" step="0.01" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15, 17, 26, 0.6); color: #fff; border: 1px solid var(--border);" value="${valor}">
                    </div>
                `,
                background: '#1e2130', color: '#e2e8f0', showCancelButton: true,
                confirmButtonText: 'Salvar Alterações', cancelButtonText: 'Cancelar',
                confirmButtonColor: '#6366f1', cancelButtonColor: '#334155',
                preConfirm: () => {
                    return {
                        nome: document.getElementById('swal-nome').value,
                        curso: document.getElementById('swal-curso').value,
                        telefone: document.getElementById('swal-tel').value,
                        valor: document.getElementById('swal-valor').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let form = document.createElement('form');
                    form.method = 'POST'; form.action = '/editar_cliente/' + id;
                    
                    ['nome', 'curso', 'telefone', 'valor'].forEach(field => {
                        let input = document.createElement('input');
                        input.type = 'hidden'; input.name = field; input.value = result.value[field];
                        form.appendChild(input);
                    });
                    
                    document.body.appendChild(form); form.submit();
                }
            });
        }

        // NOVO: Apagar Cliente com Alerta de Segurança
        function deletarCliente(id, nome) {
            Swal.fire({
                title: 'Tem Certeza Absoluta?',
                html: `Você está prestes a apagar a ficha de <b>${nome}</b>.<br>Isto também <b style="color: var(--danger);">apagará todos os arquivos Word</b> vinculados a este cliente.<br><br>Esta ação é irreversível!`,
                icon: 'warning', background: '#1e2130', color: '#e2e8f0',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#334155',
                confirmButtonText: '<i class="ph-bold ph-trash"></i> Sim, Apagar Tudo', cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/deletar_cliente/' + id;
                }
            });
        }
    </script>
{% endblock %}
