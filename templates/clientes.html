{% extends "base.html" %}
{% block content %}
    <h1 style="margin-top:0;">CRM: Gestão de Trabalhos</h1>
    
    <div class="card" style="border-top: 4px solid var(--primary);">
        <h3 style="margin-top: 0;"><i class="ph-fill ph-user-plus"></i> Novo Cliente / Trabalho</h3>
        <form method="POST" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" name="nome" placeholder="Nome do Aluno" required style="flex: 2; min-width: 150px;">
            <input type="text" name="curso" placeholder="Curso/Disciplina" style="flex: 2; min-width: 150px;">
            <input type="text" name="telefone" placeholder="WhatsApp" style="flex: 1.5; min-width: 120px;">
            <input type="text" name="ava_login" placeholder="Login AVA (Opcional)" style="flex: 1.5; min-width: 120px;">
            <input type="text" name="ava_senha" placeholder="Senha AVA (Opcional)" style="flex: 1.5; min-width: 120px;">
            <input type="number" name="valor" placeholder="R$" value="70.0" step="0.01" required style="flex: 1; min-width: 80px;">
            <button type="submit" class="btn btn-green" style="height: 44px; margin-top: 8px;"><i class="ph-bold ph-plus"></i> Criar</button>
        </form>
    </div>

    <h3 style="color: var(--warning); margin-top: 40px;"><i class="ph-fill ph-hourglass-high"></i> Fila de Produção e Pendentes</h3>
    
    {% for aluno in alunos_pendentes %}
        <div class="card" style="border-left: 4px solid {% if aluno.status == 'Produção' %}var(--warning){% else %}var(--danger){% endif %}; padding: 20px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                
                <div>
                    <h3 style="margin: 0; color: #fff; display: flex; align-items: center; gap: 10px;">
                        {{ aluno.nome }}
                        
                        <form action="/mudar_status/{{ aluno.id }}" method="POST" style="margin:0;">
                            <select name="novo_status" onchange="this.form.submit()" style="margin:0; padding: 2px 8px; font-size: 0.75rem; border-radius: 4px; font-weight: bold; background: {% if aluno.status == 'Produção' %}#f59e0b{% else %}#ef4444{% endif %}; color: #fff; border: none; outline: none; cursor: pointer;">
                                <option value="Produção" {% if aluno.status == 'Produção' %}selected{% endif %}>Em Produção</option>
                                <option value="Pendente" {% if aluno.status == 'Pendente' %}selected{% endif %}>Pronto (Falta Pagar)</option>
                                <option value="Pago">Pago (Finalizar)</option>
                            </select>
                        </form>
                    </h3>
                    
                    <div style="color: var(--text-muted); display: flex; align-items: center; gap: 15px; margin-top: 10px; font-size: 0.9rem; flex-wrap: wrap;">
                        <span><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</span>
                        <span><i class="ph ph-whatsapp-logo"></i> {{ aluno.telefone }}</span>
                        <span style="color: var(--primary); font-weight: bold;">R$ {{ "%.2f"|format(aluno.valor or 0) }}</span>
                        
                        {% if aluno.ava_login %}
                        <span style="background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; display: flex; gap: 8px;">
                            <b>AVA:</b> {{ aluno.ava_login }} 
                            <i class="ph-bold ph-copy" style="cursor:pointer; color:var(--primary);" onclick="copiarTexto('{{ aluno.ava_login }}', '{{ aluno.ava_senha }}')" title="Copiar Login e Senha"></i>
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" onclick="novoPedido('{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', '{{ aluno.ava_login|default('', true)|replace('\'', '\\\'') }}', '{{ aluno.ava_senha|default('', true)|replace('\'', '\\\'') }}')" class="btn btn-warning" title="Novo trabalho para este cliente">
                        <i class="ph-bold ph-plus-circle"></i> Novo Pedido
                    </button>
                    
                    <a href="/cliente/{{ aluno.id }}" class="btn btn-blue"><i class="ph-bold ph-folder-open"></i> Pasta</a>
                    <button type="button" onclick="cobrarWhatsapp('{{ aluno.telefone }}', '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.valor or 70.0 }}')" class="btn" style="background: #25D366; color: white;"><i class="ph-bold ph-whatsapp-logo"></i></button>
                    <button type="button" onclick="editarClienteTotal({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', {{ aluno.valor or 70.0 }}, '{{ aluno.ava_login|default('', true)|replace('\'', '\\\'') }}', '{{ aluno.ava_senha|default('', true)|replace('\'', '\\\'') }}')" class="btn" style="background: var(--border);"><i class="ph-bold ph-pencil-simple"></i></button>
                    <a href="/deletar_cliente/{{ aluno.id }}" class="btn btn-danger" onclick="return confirm('Apagar tudo deste cliente?')"><i class="ph-bold ph-trash"></i></a>
                </div>
            </div>
        </div>
    {% endfor %}

    <h3 style="color: var(--success); margin-top: 40px;"><i class="ph-fill ph-check-circle"></i> Trabalhos Finalizados (Pagos)</h3>
    {% for aluno in alunos_pagos %}
        <div class="card" style="border-left: 4px solid var(--success); opacity: 0.7; padding: 20px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0; color: #fff;">{{ aluno.nome }}</h3>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">{{ aluno.curso }} | <span style="color: var(--success); font-weight: bold;"><i class="ph-bold ph-check"></i> Pago</span></div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <form action="/mudar_status/{{ aluno.id }}" method="POST" style="margin:0;"><input type="hidden" name="novo_status" value="Pendente"><button type="submit" class="btn" style="background: var(--border);" title="Desfazer pagamento"><i class="ph-bold ph-arrow-u-up-left"></i></button></form>
                    <a href="/cliente/{{ aluno.id }}" class="btn btn-blue"><i class="ph-bold ph-folder-open"></i> Pasta</a>
                    <button type="button" onclick="novoPedido('{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', '{{ aluno.ava_login|default('', true)|replace('\'', '\\\'') }}', '{{ aluno.ava_senha|default('', true)|replace('\'', '\\\'') }}')" class="btn btn-warning"><i class="ph-bold ph-plus-circle"></i> Novo Pedido</button>
                </div>
            </div>
        </div>
    {% endfor %}

    <div id="zap-template" style="display:none;">{{ config.whatsapp_template if config else 'Olá {nome}, seu trabalho está pronto! Valor: R$ {valor}' }}</div>

    <script>
        function copiarTexto(login, senha) {
            navigator.clipboard.writeText(`Login AVA: ${login}\nSenha AVA: ${senha}`);
            Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, icon: 'success', title: 'Copiado!', background: '#1e2130', color: '#10b981' });
        }

        function cobrarWhatsapp(telefone, nome, curso, valor) {
            let msg = document.getElementById('zap-template').innerText.replace(/{nome}/g, nome).replace(/{curso}/g, curso).replace(/{valor}/g, parseFloat(valor).toFixed(2));
            window.open(`https://wa.me/55${telefone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function novoPedido(nome, tel, login, senha) {
            Swal.fire({
                title: 'Novo Pedido para o Cliente',
                html: `
                    <div style="text-align: left;">
                        <input id="sw-nome" value="${nome}" type="hidden">
                        <input id="sw-tel" value="${tel}" type="hidden">
                        <input id="sw-login" value="${login}" type="hidden">
                        <input id="sw-senha" value="${senha}" type="hidden">
                        <p style="color:var(--text-muted); font-size:0.9rem;">Criando nova ficha de trabalho para <b>${nome}</b>.</p>
                        <label>Qual a nova disciplina?</label>
                        <input id="sw-curso" class="swal2-input" style="width:100%; margin: 5px 0 15px 0;">
                        <label>Qual o valor (R$)?</label>
                        <input id="sw-valor" type="number" step="0.01" value="70.0" class="swal2-input" style="width:100%; margin: 5px 0;">
                    </div>
                `,
                background: '#1e2130', color: '#e2e8f0', confirmButtonText: 'Criar Novo Trabalho', confirmButtonColor: '#f59e0b', showCancelButton: true,
                preConfirm: () => {
                    let form = document.createElement('form'); form.method = 'POST'; form.action = '/clientes';
                    ['nome','tel','login','senha','curso','valor'].forEach(k => {
                        let i = document.createElement('input'); i.type = 'hidden'; 
                        i.name = k === 'tel' ? 'telefone' : (k.includes('login') ? 'ava_login' : (k.includes('senha') ? 'ava_senha' : k));
                        i.value = document.getElementById('sw-'+k).value; form.appendChild(i);
                    });
                    document.body.appendChild(form); form.submit();
                }
            });
        }

        function editarClienteTotal(id, nome, curso, telefone, valor, login, senha) {
            Swal.fire({
                title: 'Editar Ficha',
                html: `
                    <div style="text-align: left; display: flex; flex-direction: column; gap: 10px;">
                        <input id="sw-nome" class="swal2-input" value="${nome}" placeholder="Nome">
                        <input id="sw-curso" class="swal2-input" value="${curso}" placeholder="Curso">
                        <input id="sw-tel" class="swal2-input" value="${telefone}" placeholder="WhatsApp">
                        <input id="sw-login" class="swal2-input" value="${login}" placeholder="Login AVA">
                        <input id="sw-senha" class="swal2-input" value="${senha}" placeholder="Senha AVA">
                        <input id="sw-valor" type="number" step="0.01" class="swal2-input" value="${valor}" placeholder="Valor R$">
                    </div>
                `,
                background: '#1e2130', color: '#e2e8f0', showCancelButton: true, confirmButtonText: 'Salvar', confirmButtonColor: '#6366f1',
                preConfirm: () => {
                    let form = document.createElement('form'); form.method = 'POST'; form.action = '/editar_cliente/' + id;
                    ['nome','curso','tel','login','senha','valor'].forEach(k => {
                        let i = document.createElement('input'); i.type = 'hidden'; 
                        i.name = k === 'tel' ? 'telefone' : (k.includes('login') ? 'ava_login' : (k.includes('senha') ? 'ava_senha' : k));
                        i.value = document.getElementById('sw-'+k).value; form.appendChild(i);
                    });
                    document.body.appendChild(form); form.submit();
                }
            });
        }
    </script>
{% endblock %}
