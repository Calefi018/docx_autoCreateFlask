{% extends "base.html" %}
{% block content %}
    <style>
        /* Estilos do Quadro Kanban */
        .kanban-board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; }
        .kanban-col { flex: 1; min-width: 320px; background: rgba(30, 33, 48, 0.4); border-radius: 12px; padding: 15px; border: 1px dashed var(--border); }
        .kanban-items { min-height: 400px; padding: 10px 0; }
        .kanban-card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--border); cursor: grab; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .kanban-card:active { cursor: grabbing; opacity: 0.8; transform: scale(0.98); }
        
        /* Cores de status das cartas */
        .k-producao { border-left-color: var(--warning); }
        .k-pendente { border-left-color: var(--danger); }
        .k-pago { border-left-color: var(--success); opacity: 0.7; }
    </style>

    <h1 style="margin-top:0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        CRM de Clientes 
        <button class="btn btn-green" onclick="document.getElementById('formNovo').style.display='block'"><i class="ph-bold ph-plus"></i> Cliente Avulso</button>
    </h1>
    
    <div id="formNovo" class="card" style="display: none; border-top: 4px solid var(--primary);">
        <h3 style="margin-top: 0;">Cadastrar Manualmente na Fila</h3>
        <form method="POST" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" name="nome" placeholder="Nome do Aluno" required style="flex: 2; min-width: 150px;">
            <input type="text" name="curso" placeholder="Curso/Disciplina" style="flex: 2; min-width: 150px;">
            <input type="text" name="telefone" placeholder="WhatsApp (Apenas Números)" style="flex: 2; min-width: 150px;">
            <input type="number" name="valor" placeholder="R$ 70.0" value="70.00" step="0.01" required style="flex: 1; min-width: 100px;">
            <button type="submit" class="btn btn-primary" style="height: 44px; margin-top: 8px;">Salvar na Produção</button>
            <button type="button" class="btn btn-danger" style="height: 44px; margin-top: 8px;" onclick="document.getElementById('formNovo').style.display='none'">Cancelar</button>
        </form>
    </div>

    <div class="kanban-board">
        
        <div class="kanban-col">
            <h3 style="margin: 0; color: var(--warning); display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-gear"></i> Em Produção</h3>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; margin-bottom: 15px;">A IA ainda não gerou o documento.</p>
            
            <div class="kanban-items" data-status="Produção">
                {% for aluno in alunos %}
                {% if aluno.status == 'Produção' or (aluno.status == 'Pendente' and not 'Pago' in aluno.status and loop.index is odd) %}
                <div class="kanban-card k-producao" data-id="{{ aluno.id }}">
                    <h4 style="margin: 0 0 10px 0; color: #fff;">{{ aluno.nome }}</h4>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">
                        <div style="margin-bottom: 4px;"><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</div>
                        <div><i class="ph ph-currency-dollar"></i> R$ {{ "%.2f"|format(aluno.valor or 70.0) }}</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <a href="/cliente/{{ aluno.id }}" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem; flex: 1;"><i class="ph-bold ph-folder"></i> Abrir</a>
                        <button onclick="editarClienteTotal({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', {{ aluno.valor or 70.0 }})" class="btn" style="background: var(--border); padding: 6px 10px;"><i class="ph-bold ph-pencil"></i></button>
                    </div>
                </div>
                {% endif %}{% endfor %}
            </div>
        </div>

        <div class="kanban-col">
            <h3 style="margin: 0; color: var(--danger); display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-hourglass"></i> Aguardando Pix</h3>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; margin-bottom: 15px;">Documento pronto. Liberar só após pagamento.</p>
            
            <div class="kanban-items" data-status="Pendente">
                {% for aluno in alunos %}{% if aluno.status == 'Pendente' %}
                <div class="kanban-card k-pendente" data-id="{{ aluno.id }}">
                    <h4 style="margin: 0 0 10px 0; color: #fff;">{{ aluno.nome }}</h4>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">
                        <div style="margin-bottom: 4px;"><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</div>
                        <div><i class="ph ph-currency-dollar"></i> R$ {{ "%.2f"|format(aluno.valor or 70.0) }}</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <a href="/cliente/{{ aluno.id }}" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem;"><i class="ph-bold ph-folder"></i></a>
                        <button onclick="editarClienteTotal({{ aluno.id }}, '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.telefone|replace('\'', '\\\'') }}', {{ aluno.valor or 70.0 }})" class="btn" style="background: var(--border); padding: 6px 10px;"><i class="ph-bold ph-pencil"></i></button>
                        
                        <button onclick="cobrarWhatsapp('{{ aluno.telefone }}', '{{ aluno.nome|replace('\'', '\\\'') }}', '{{ aluno.curso|replace('\'', '\\\'') }}', '{{ aluno.valor or 70.0 }}')" class="btn btn-green" style="padding: 6px 10px; font-size: 0.8rem; flex: 1;"><i class="ph-bold ph-whatsapp-logo"></i> Cobrar</button>
                    </div>
                </div>
                {% endif %}{% endfor %}
            </div>
        </div>

        <div class="kanban-col">
            <h3 style="margin: 0; color: var(--success); display: flex; align-items: center; gap: 8px;"><i class="ph-fill ph-check-circle"></i> Pagos</h3>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; margin-bottom: 15px;">Disponível no Portal do Aluno.</p>
            
            <div class="kanban-items" data-status="Pago">
                {% for aluno in alunos %}{% if aluno.status == 'Pago' %}
                <div class="kanban-card k-pago" data-id="{{ aluno.id }}">
                    <h4 style="margin: 0 0 10px 0; color: #fff;">{{ aluno.nome }}</h4>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">
                        <div style="margin-bottom: 4px;"><i class="ph ph-graduation-cap"></i> {{ aluno.curso }}</div>
                        <div style="color: var(--success); font-weight: bold;"><i class="ph ph-check"></i> R$ {{ "%.2f"|format(aluno.valor or 70.0) }} Recebido</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <a href="/cliente/{{ aluno.id }}" class="btn btn-blue" style="padding: 6px 10px; font-size: 0.8rem; flex: 1;"><i class="ph-bold ph-folder"></i> Ver Arquivos</a>
                    </div>
                </div>
                {% endif %}{% endfor %}
            </div>
        </div>
    </div>

    <div id="zap-template" style="display:none;">{{ config.whatsapp_template if config else 'Olá {nome}, seu trabalho de {curso} está pronto! O valor é R$ {valor}.' }}</div>

    <script>
        // Inteligência do Kanban (Arrastar e Soltar)
        document.querySelectorAll('.kanban-items').forEach(coluna => {
            new Sortable(coluna, {
                group: 'crm', 
                animation: 150, 
                ghostClass: 'bg-indigo-900',
                onEnd: function (evt) {
                    let item = evt.item;
                    let novoStatus = evt.to.parentElement.dataset.status;
                    let idAluno = item.dataset.id;
                    
                    // Altera as cores imediatamente no ecrã para feedback visual
                    item.classList.remove('k-producao', 'k-pendente', 'k-pago');
                    if(novoStatus == 'Produção') item.classList.add('k-producao');
                    if(novoStatus == 'Pendente') item.classList.add('k-pendente');
                    if(novoStatus == 'Pago') item.classList.add('k-pago');

                    // Comunica a mudança ao banco de dados em plano de fundo
                    fetch('/atualizar_status_kanban/' + idAluno, {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({status: novoStatus})
                    });
                }
            });
        });

        // Lógica do Botão de WhatsApp
        function cobrarWhatsapp(telefone, nome, curso, valor) {
            let template = document.getElementById('zap-template').innerText;
            
            // Troca as tags pelos valores reais do aluno
            let msgFormatada = template
                .replace(/{nome}/g, nome)
                .replace(/{curso}/g, curso)
                .replace(/{valor}/g, parseFloat(valor).toFixed(2));
                
            let zapNumero = telefone.replace(/\D/g, ''); // Limpa traços e espaços do número
            window.open(`https://wa.me/55${zapNumero}?text=${encodeURIComponent(msgFormatada)}`, '_blank');
        }

        // Lógica do Pop-up de Edição Total de Cliente
        function editarClienteTotal(id, nome, curso, telefone, valor) {
            Swal.fire({
                title: 'Editar Ficha do Cliente',
                html: `
                    <div style="text-align: left; margin-top: 15px;">
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Nome do Aluno</label>
                        <input id="swal-nome" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15,17,26,0.6); color: #fff; border: 1px solid var(--border);" value="${nome}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Curso/Disciplina</label>
                        <input id="swal-curso" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15,17,26,0.6); color: #fff; border: 1px solid var(--border);" value="${curso}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">WhatsApp do Aluno</label>
                        <input id="swal-tel" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0 15px 0; background: rgba(15,17,26,0.6); color: #fff; border: 1px solid var(--border);" value="${telefone}">
                        
                        <label style="color: var(--text-muted); font-size: 0.85rem; margin-left: 5px;">Valor Combinado (R$)</label>
                        <input id="swal-valor" type="number" step="0.01" class="swal2-input" style="width: 100%; box-sizing: border-box; margin: 5px 0; background: rgba(15,17,26,0.6); color: #fff; border: 1px solid var(--border);" value="${valor}">
                    </div>
                `,
                background: '#1e2130', color: '#e2e8f0', 
                showCancelButton: true, confirmButtonText: 'Salvar Alterações', confirmButtonColor: '#6366f1',
                preConfirm: () => { 
                    return { 
                        nome: document.getElementById('swal-nome').value, 
                        curso: document.getElementById('swal-curso').value, 
                        telefone: document.getElementById('swal-tel').value, 
                        valor: document.getElementById('swal-valor').value 
                    } 
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let form = document.createElement('form'); 
                    form.method = 'POST'; 
                    form.action = '/editar_cliente/' + id;
                    
                    ['nome', 'curso', 'telefone', 'valor'].forEach(field => { 
                        let input = document.createElement('input'); 
                        input.type = 'hidden'; 
                        input.name = field; 
                        input.value = result.value[field]; 
                        form.appendChild(input); 
                    });
                    
                    document.body.appendChild(form); 
                    form.submit();
                }
            });
        }
    </script>
{% endblock %}
